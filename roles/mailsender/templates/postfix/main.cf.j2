# Postfix main.cf - Mailsender Role Configuration
# Generated by Ansible - do not edit manually

# Basic identity
myhostname = {{ mailsender_hostname }}
myorigin = {{ mailsender_domain }}
mydomain = {{ mailsender_domain }}

# Network configuration
inet_interfaces = all
inet_protocols = {{ 'all' if mailsender_enable_ipv6 else 'ipv4' }}

# Destinations - only localhost for local delivery
mydestination = localhost

# No relayhost - direct to MX delivery
relayhost =

# Message size limit
message_size_limit = {{ mailsender_message_size_limit }}

# Disable local delivery to avoid creating user mailboxes
local_transport = error:local delivery disabled

# TLS configuration for outbound connections
smtp_tls_security_level = may
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
smtp_tls_loglevel = 1

# TLS configuration for inbound connections (submission)
smtpd_tls_cert_file = /etc/letsencrypt/live/{{ mailsender_hostname }}/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/{{ mailsender_hostname }}/privkey.pem
smtpd_tls_security_level = may
smtpd_tls_auth_only = yes
smtpd_tls_loglevel = 1
smtpd_tls_received_header = yes
smtpd_tls_session_cache_timeout = 3600s

# SASL authentication via Dovecot
smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain =

# Basic restrictions - only allow authenticated users
smtpd_recipient_restrictions =
    permit_sasl_authenticated,
    reject_unauth_destination

# Client restrictions
smtpd_client_restrictions =
    permit_sasl_authenticated,
    reject

# Log settings
maillog_file = /var/log/postfix.log

# Compatibility level
compatibility_level = 3.6
